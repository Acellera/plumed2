patch -u -l -b -F 5 --suffix=.preplumed "./PW/src/plugin_forces.f90" << \EOF_EOF
--- ./PW/src/plugin_forces.f90.preplumed
+++ ./PW/src/plugin_forces.f90
@@ -16,9 +16,42 @@
   USE kinds,            ONLY : DP
   USE io_files,         ONLY : outdir
   !
   USE plugin_flags
   !
+  USE cell_base,        ONLY : alat, at
+  USE ions_base,        ONLY : tau, nat,amass
+  USE force_mod,        ONLY : force
+  USE control_flags,    ONLY : istep
+  USE ener,             ONLY : etot 
+  !
   IMPLICIT NONE
   !
+  INTEGER:: i,j
+  REAL(DP) :: at_plumed(3,3)
+  REAL(DP), ALLOCATABLE :: tau_plumed(:,:)
+  !
+  ! this is ignored by QE, but required for plumed to work consistently
+  REAL(DP) :: virial(3,3)
+  IF(use_plumed) then
+    IF(ionode)THEN
+      at_plumed=alat*at;  ! the cell, rescaled properly
+      allocate(tau_plumed(3,nat))
+      tau_plumed=alat*tau
+      virial=0.0
+
+      CALL plumed_f_gcmd("setStep"//char(0),istep)
+      CALL plumed_f_gcmd("setMasses"//char(0),amass)
+      CALL plumed_f_gcmd("setForces"//char(0),force)
+      CALL plumed_f_gcmd("setPositions"//char(0),tau_plumed)
+      CALL plumed_f_gcmd("setBox"//char(0),at_plumed)
+      CALL plumed_f_gcmd("setVirial"//char(0),virial)
+      CALL plumed_f_gcmd("setEnergy"//char(0),etot)
+      CALL plumed_f_gcmd("calc"//char(0),0)
+
+      deallocate(tau_plumed)
+    ENDIF
+    CALL mp_bcast(force, ionode_id, intra_image_comm)
+  ENDIF
+  !
   !
 END SUBROUTINE plugin_forces
EOF_EOF
patch -u -l -b -F 5 --suffix=.preplumed "./PW/src/plugin_initialization.f90" << \EOF_EOF
--- ./PW/src/plugin_initialization.f90.preplumed
+++ ./PW/src/plugin_initialization.f90
@@ -13,9 +13,49 @@
   USE kinds,            ONLY : DP
   USE io_files,         ONLY : tmp_dir
   !
   USE plugin_flags
   !
+  USE ions_base,        ONLY : amass, ityp, nat
+  !
+  USE dynamics_module,  ONLY : dt
+  USE constants,        ONLY : au_ps
+  !
+  !
   IMPLICIT NONE
   !
+  INTEGER  :: na
+  INTEGER  :: plumedavailable
+  REAL*8   :: energyUnits,lengthUnits,timeUnits 
+  !
+  IF(use_plumed) then
+
+     CALL plumed_f_installed(plumedavailable)
+   
+     IF(plumedavailable<=0)THEN
+        write(stdout,*)"YOU ARE LOOKING FOR PLUMED BUT LOOKS LIKE IT IS NOT AVAILABLE: DO YOU HAVE IT IN YOUR LD_LIBRARY_PATH?" 
+        STOP 
+     ELSE 
+        IF (ionode) THEN
+
+            write(stdout,*)"  CREATING PLUMED FROM THE PROGRAM" 
+            call plumed_f_gcreate()
+            CALL plumed_f_gcmd("setRealPrecision"//char(0),8)
+            energyUnits=1312.75  ! Ry to kjoule mol 
+            lengthUnits=0.0529177249 ! bohr to nm
+            timeUnits=2*au_ps ! internal time to ps
+            call plumed_f_gcmd("setMDEnergyUnits"//char(0),energyUnits)
+            call plumed_f_gcmd("setMDLengthUnits"//char(0),lengthUnits)
+            call plumed_f_gcmd("setMDTimeUnits"//char(0),timeUnits)
+            call plumed_f_gcmd("setPlumedDat"//char(0),"plumed.dat"//char(0))
+            call plumed_f_gcmd("setLogFile"//char(0),"PLUMED.OUT"//char(0))
+            call plumed_f_gcmd("setNatoms"//char(0),nat)
+            call plumed_f_gcmd("setMDEngine"//char(0),"qespresso");
+            call plumed_f_gcmd("setTimestep"//char(0),dt);
+            call plumed_f_gcmd("init"//char(0),0);
+    
+        ENDIF
+     ENDIF
+  ENDIF
+  !
   !
 END SUBROUTINE plugin_initialization
EOF_EOF
