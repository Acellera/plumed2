/**
\page belfast-8 Belfast tutorial: Replica exchange II and Multiple walkers

\section Aims

The aim of this tutorial is to introduce the users to the use of Bias-Exchange Metadynamics. We will go through the writing of
the input files for BEMETA for a simple case of three alanines and we will use METAGUI to to analyse them. We will compare
the results of WT-BEMETA and STANDARD-BEMETA with four independent runs on the four Collective Variables. Finally we will
use a simplified version of BEMETA that is Multiple Walkers Metadynamics.

\section belfast-1-lo Learning Outcomes

Once this tutorial is completed students will:

- Know how to run a Bias-Exchange simulation using PLUMED and GROMACS 
- Know how to analyse the results of BEMETA with the help of METAGUI
- Know how to run a Multiple Walker simulation 

\section Resources

The <a href="tutorial-resources/belfast-8.tar.gz" download="belfast-8.tar.gz"> tarball </a> for this project contains the following files:

- trajectory-short.xyz : a (short) trajectory for a 16 residue protein in xyz format. All calculations with plumed driver use this trajectory.
- template.pdb : a single frame from the trajectory that can be used in conjuction with the \ref MOLINFO command

\section Instructions

\subsection bemeta Bias-Exchange Metadynamics

In all variants of metadynamics the free-energy landscape of the system is reconstructed by gradually
filling the local minima with gaussian hills. The dimensionality of the landscape is equal to the
number of CVs which are biased, and typically a number of CVs smaller than three is employed.
The reason for this is that qualitatively, if the CVs are not correlated among them, the simulation time
required to fill the free-energy landscape grows exponentially with the number of CVs.
This limitation can be severe when studying complex transformations or reactions in which
more than say three relevant CVs can be identified.

A possible technique to overcome this limitation is parallel-tempering metadynamics, \ref belfast-7.
A different solution is performing a bias-exchange simulation:
in this approach a relatively large number N of CVs  is chosen to describe the possible transformations
of the system (e.g., to study the conformations of a peptide one may consider all the dihedral angles between amino acids).
Then, N metadynamics simulations (replicas) are run on the same system at the same temperature, biasing a different
CV in each replica. 

Normally, in these conditions, each bias profile would converge very slowly to the
equilibrium free-energy, due to hysteresis. Instead, in the bias-exchange approach every fixed number of steps
(say 10,000) an exchange is attempted between a randomly selected pair of replicas \f$ a \f$ and \f$ b \f$.
The probability to accept the exchange is given by a Metropolis rule:

\f[
\begin{eqnarray}
\min\left( 1, \exp \left[ \beta ( V_G^a(x^a,t)+V_G^b(x^b,t)-V_G^a(x^b,t)-V_G^b(x^a,t) ) \right] \right)
\end{eqnarray}
\f]

where \f$ x^{a} \f$ and \f$ x^{b} \f$ are the coordinates of replicas \f$a \f$ and \f$ b \f$
and \f$ V_{G}^{a(b)}\left(x,t\right) \f$ is the metadynamics potential acting on the replica \f$ a \f$( \f$ b \f$).
Each trajectory evolves through the high dimensional free energy landscape in the space of the CVs sequentially biased by
different metadynamics potentials acting on one CV at each time. 
The results of the simulation are N one-dimensional projections of the free energy.

In the following example, a bias-exchange simulation is performed on a Val-Ile-Leu peptide (zwitterionic form, in vacuum with 
\f$ \epsilon=80 \f$, force field amber03), using the four backbone dihedral angles as CVs. 

Four replicas of the system are employed, each one biased on a different CV,
thus four similar Plumed input files are prepared as follows:

- a common input file in which all the collective variables are define:

\verbatim
MOLINFO STRUCTURE=VIL.pdb
RANDOM_EXCHANGES

cv1: TORSION ATOMS=@psi-1
cv2: TORSION ATOMS=@phi-2
cv3: TORSION ATOMS=@psi-2
cv4: TORSION ATOMS=@phi-3
\endverbatim

NOTE:
1. By using \ref MOLINFO we can use shortcut to select atoms for dihedral angles (currently @phi, @psi, @omega and @chi1 are
available).
2. We use cv# as label in order to make the output compatible with METAGUI.
3. \ref RANDOM_EXCHANGES generates random exchanges list that are sent back to GROMACS.

- four additional input files that \ref INCLUDE the common input and define the four \ref METAD along the four CVs, respectively.

\verbatim
INCLUDE FILE=plumed-common.dat
be: METAD ARG=cv1 HEIGHT=0.2 SIGMA=0.2 PACE=100 GRID_MIN=-pi GRID_MAX=pi GRID_BIN=200 
PRINT ARG=cv1,cv2,cv3,cv4 STRIDE=1000 FILE=COLVAR
\endverbatim

NOTE:
1. in COLVAR we \ref PRINT only the four collective variables, always in the same order in such a way that COLVARs are compatible
with METAGUI
2. if you want to print additional information, like the \ref METAD bias it is possibile to use additional \ref PRINT keyword
3. Originally Bias-Exchange has been used without Well-Tempered Metadynamics but nothing prevents its use.

\verbatim
PRINT ARG=cv1,be.bias STRIDE=xxx FILE=BIAS
\endverbatim

The four replicas start from the same GROMACS topology file replicated four times: topol0.tpr, topol1.tpr, topol2.tpr, topol3.tpr.
Finally, GROMACS is launched as a parallel run on 4 cores, with one replica per core, with the command 

\verbatim
mpirun -np 4 mdrun_mpi -s topol -plumed plumed -multi 4 -replex 1000 >& log &
\endverbatim

where -replex 1000 indicates that every 1000 molecular-dynamics steps
all replicas are randomly paired (e.g. 0-2 and 1-3) and exchanges are attempted
between each pair (as printed in the GROMACS *.log files).


*/

link: @subpage belfast-8

description: Bias exchange and multiple walkers


